name: Enhance Draft Posts

on:
  workflow_dispatch:
    inputs:
      model:
        description: 'LLM model to use'
        required: false
        type: string
        default: 'amazon/nova-2-lite-v1:free'

      temperature:
        description: 'Temperature 0.0-2.0'
        required: false
        type: string
        default: '0.7'

      enhancement_mode:
        description: 'Enhancement mode'
        required: false
        type: choice
        default: 'complete'
        options:
          - grammar_only
          - expand
          - complete
          - custom

      custom_prompt:
        description: 'Custom prompt (when mode=custom)'
        required: false
        type: string
        default: ''

      max_steps:
        description: 'Max agent steps'
        required: false
        type: string
        default: '10'

      debug_mode:
        description: 'Enable verbose logging'
        required: false
        type: boolean
        default: false

jobs:
  enhance:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Setup SSH key for private repos
      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # Fix dependencies to use GitHub SSH references instead of yalc
      - name: Update dependencies for CI
        run: |
          rm -rf package-lock.json .yalc node_modules
          npm pkg set dependencies.blog-engine="git+ssh://git@github.com/geek-blog/blog-engine.git"
          npm pkg set dependencies.blog-enhancer="git+ssh://git@github.com/geek-blog/blog-enhancer.git"
          echo "Updated package.json dependencies"

      - name: Determine final configuration
        id: config
        run: |
          # Model: input > repo var > code default
          MODEL="${{ inputs.model }}"
          if [ -z "$MODEL" ]; then
            MODEL="${{ vars.DEFAULT_MODEL }}"
            if [ -z "$MODEL" ]; then
              MODEL="amazon/nova-2-lite-v1:free"
            fi
          fi
          echo "model=$MODEL" >> $GITHUB_OUTPUT
          echo "MODEL=$MODEL" >> $GITHUB_ENV

          # Temperature: input > repo var > code default
          TEMP="${{ inputs.temperature }}"
          if [ -z "$TEMP" ]; then
            TEMP="${{ vars.DEFAULT_TEMPERATURE }}"
            if [ -z "$TEMP" ]; then
              TEMP="0.7"
            fi
          fi
          echo "temperature=$TEMP" >> $GITHUB_OUTPUT
          echo "TEMPERATURE=$TEMP" >> $GITHUB_ENV

          # Enhancement mode: input > repo var > code default
          MODE="${{ inputs.enhancement_mode }}"
          if [ -z "$MODE" ]; then
            MODE="${{ vars.DEFAULT_ENHANCEMENT_MODE }}"
            if [ -z "$MODE" ]; then
              MODE="complete"
            fi
          fi
          echo "mode=$MODE" >> $GITHUB_OUTPUT
          echo "ENHANCEMENT_MODE=$MODE" >> $GITHUB_ENV

          # Max steps: input > repo var > code default
          STEPS="${{ inputs.max_steps }}"
          if [ -z "$STEPS" ]; then
            STEPS="${{ vars.DEFAULT_MAX_STEPS }}"
            if [ -z "$STEPS" ]; then
              STEPS="10"
            fi
          fi
          echo "max_steps=$STEPS" >> $GITHUB_OUTPUT
          echo "MAX_STEPS=$STEPS" >> $GITHUB_ENV

          # Custom prompt
          echo "CUSTOM_PROMPT=${{ inputs.custom_prompt }}" >> $GITHUB_ENV

          # Debug mode
          if [ "${{ inputs.debug_mode }}" = "true" ]; then
            echo "DEBUG=true" >> $GITHUB_ENV
          fi

      - name: Show configuration
        run: |
          echo "## ðŸ”§ Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Model | \`${{ steps.config.outputs.model }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Temperature | \`${{ steps.config.outputs.temperature }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Enhancement Mode | \`${{ steps.config.outputs.mode }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Max Steps | \`${{ steps.config.outputs.max_steps }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Debug Mode | \`${{ inputs.debug_mode }}\` |" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.custom_prompt }}" ]; then
            echo "| Custom Prompt | \`${{ inputs.custom_prompt }}\` |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Run enhancement agent
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
        run: |
          echo "## ðŸ¤– Enhancement Agent Output" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          npx blog-enhancer enhance 2>&1 | tee agent-output.log
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Find enhanced files
        id: find-files
        run: |
          if [ -d "content/posts" ]; then
            ENHANCED_FILES=$(find content/posts -name "*-enhanced.md" 2>/dev/null || echo "")
            if [ -n "$ENHANCED_FILES" ]; then
              echo "files<<EOF" >> $GITHUB_OUTPUT
              echo "$ENHANCED_FILES" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
              echo "count=$(echo "$ENHANCED_FILES" | wc -l)" >> $GITHUB_OUTPUT
            else
              echo "files=" >> $GITHUB_OUTPUT
              echo "count=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "files=" >> $GITHUB_OUTPUT
            echo "count=0" >> $GITHUB_OUTPUT
          fi

      - name: Create preview summary
        if: steps.find-files.outputs.count > 0
        run: |
          echo "## ðŸ“ Enhancement Preview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Found ${{ steps.find-files.outputs.count }} enhanced file(s)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Process each enhanced file
          while IFS= read -r enhanced_file; do
            if [ -n "$enhanced_file" ]; then
              # Get original filename (remove -enhanced.md, add .draft.md)
              basename_enhanced=$(basename "$enhanced_file" -enhanced.md)
              original_file="${enhanced_file%-enhanced.md}.draft.md"

              echo "### ðŸ“„ $(basename "$enhanced_file")" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              # Show word count comparison if original exists
              if [ -f "$original_file" ]; then
                orig_words=$(wc -w < "$original_file")
                enhanced_words=$(wc -w < "$enhanced_file")
                diff_words=$((enhanced_words - orig_words))

                echo "**Statistics:**" >> $GITHUB_STEP_SUMMARY
                echo "- Original: $orig_words words" >> $GITHUB_STEP_SUMMARY
                echo "- Enhanced: $enhanced_words words" >> $GITHUB_STEP_SUMMARY
                if [ $diff_words -gt 0 ]; then
                  echo "- Change: +$diff_words words" >> $GITHUB_STEP_SUMMARY
                else
                  echo "- Change: $diff_words words" >> $GITHUB_STEP_SUMMARY
                fi
                echo "" >> $GITHUB_STEP_SUMMARY

                # Show diff (limited to avoid huge output)
                echo "<details><summary>ðŸ“Š Show Diff</summary>" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "\`\`\`diff" >> $GITHUB_STEP_SUMMARY
                git diff --no-index "$original_file" "$enhanced_file" | head -n 200 >> $GITHUB_STEP_SUMMARY || true
                echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "</details>" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi

              # Show enhanced content preview (first 100 lines)
              echo "<details><summary>âœ¨ Show Enhanced Version</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`markdown" >> $GITHUB_STEP_SUMMARY
              head -n 100 "$enhanced_file" >> $GITHUB_STEP_SUMMARY
              if [ $(wc -l < "$enhanced_file") -gt 100 ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "... (truncated, download artifact for full content)" >> $GITHUB_STEP_SUMMARY
              fi
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done <<< "${{ steps.find-files.outputs.files }}"

      - name: Upload enhanced files as artifacts
        if: steps.find-files.outputs.count > 0
        uses: actions/upload-artifact@v4
        with:
          name: enhanced-blog-posts
          path: |
            content/posts/*-enhanced.md
            agent-output.log
          retention-days: 7

      - name: Add download instructions
        if: steps.find-files.outputs.count > 0
        run: |
          echo "## ðŸ“¥ Download & Apply" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Enhanced files are available as artifacts above." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**To apply the changes:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the artifact" >> $GITHUB_STEP_SUMMARY
          echo "2. Review the enhanced content" >> $GITHUB_STEP_SUMMARY
          echo "3. If approved, copy the content to your draft file" >> $GITHUB_STEP_SUMMARY
          echo "4. Rename the file (remove \`.draft\` from filename)" >> $GITHUB_STEP_SUMMARY
          echo "5. Commit and push the final version" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: No files found
        if: steps.find-files.outputs.count == 0
        run: |
          echo "## âš ï¸ No Enhanced Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No \`*.draft.md\` files were found in \`content/posts/\` directory." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please ensure you have draft files with the \`.draft.md\` extension." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
